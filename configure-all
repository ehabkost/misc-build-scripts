#!/bin/bash -x
set -e

mydir="$(dirname "$0")"
mydir="$(readlink -f "$mydir")"
ARGS=("$@")

if [ -f vl.c ];then
	QEMU_DIR=".."
else
	QEMU_DIR="$mydir/../qemu"
fi

for d in "$mydir/build-configs"/*;do
	name="$(basename "$d")"
	mkdir -p "$name"
	if ! ( cd "$name" && sh -x "$mydir/build-configs/$name/configure" "${ARGS[@]}"; );then
		echo "ERROR: Configure of ${name} failed" >&2
		ERRORS="$ERRORS ${name}"
	fi
done

if [ -n "$ERRORS" ];then
	echo ERRORS ABOVE: $ERRORS >&2
	exit 1
fi
